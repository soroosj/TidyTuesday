---
title: "Crop Yields"
author: "Joel Soroos"
date: "9/30/2020"
output: html_document
---


##1. Source data
```{r source, warning = FALSE, message = FALSE}

   library(tidyverse)
   library(tidytuesdayR)
   library(knitr)
   library(janitor)

   tuesdata <- tidytuesdayR::tt_load('2020-09-01') 
   crops_raw <- tuesdata$key_crop_yields %>%
      clean_names()
   
   opts_chunk$set(warning = FALSE, message = FALSE)
```


##2. Exploratory Data Analysis
```{r skim, warning = F, message =F}

   library(skimr)

   skim (crops_raw)
```


##3a. Transform data
```{r transform, message = F}

   library (countrycode)
   library (glue)

   crops <- crops_raw %>%
      pivot_longer (cols = 4:14, names_to = "commodity", values_to = "yield") %>%
      rename (country = entity) %>%
      mutate (
         commodity = if_else (commodity == "cocoa_beans_tonnes_per_hectare", word(commodity, 1, sep = "_"), word (commodity, sep = "_")),
         commodity = str_to_title(commodity),
         continent = countrycode (code, origin = 'iso3c', destination = 'continent'),
         region = countrycode (code, origin = 'iso3c', destination = 'region23'),
         decade = glue("{floor(year/10)*10}s")
         ) %>%
      drop_na () %>%
      filter (commodity == "Wheat")%>%
      select (continent, region, country, commodity, decade, year, yield) %>%
      arrange (continent, region, country, commodity, year)
```


##3b. Calculate medians by decade
```{r}
   
   crops_median <- crops %>%
      group_by (continent, region, decade) %>%
      summarize (median = round(median (yield),2)) %>%
      pivot_wider (names_from = decade, values_from = median)
```


#4.  Visualizing
```{r}

   library(gt)

   crops_median %>%
      group_by (continent) %>%
      gt () %>%
         tab_header (title =  md("**Banana Yields Across Regions by Decade**")) %>%
         tab_source_note ("Table: Joel Soroos @soroosj  | Data: Our Wold in Data") %>%
         data_color(
            columns = vars("1960s","1970s","1980s","1990s","2000s","2010s"),
            colors = scales::col_numeric(
               palette = c("#ffffff", "#f2fbd2", "#c9ecb4", "#93d3ab", "#35b0ab"),
               domain = NULL
                  )
            ) %>%
        summary_rows(
           groups = TRUE,
           columns = vars("1960s","1970s","1980s","1990s","2000s","2010s"),
           fns = list(mean = "mean")
            ) %>%
         gtsave("crops.png")
```